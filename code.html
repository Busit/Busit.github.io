<!DOCTYPE html>
<html>
	<head>
		<title>Busit - Developpers</title>
		<meta name="description" content="Busit Developper Portal" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="cache-control" content="no-cache, must-revalidate" /> 
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" /> 
		<link rel="shortcut icon" href="img/favicon.ico" />
		<link rel="stylesheet" href="css/main.css" type="text/css" />
		<script type="text/javascript" src="js/main.js"></script>
		<script type="text/javascript" src="js/jquery.min.js"></script>
		
		<link class="codestyle" rel="stylesheet" href="css/github.css">
		<script type="text/javascript" src="js/highlight.pack.js"></script>
	</head>
	<body>
		<div id="footerfix">
			<header>
				<div class="content">
					<div class="logo">
						<a href="https://www.busit.com"><img src="img/logo_white.png" alt="logo" /></a>
						<em>Developper Portal</em>
					</div>
			<nav id="navigation">
				<ul id="mainmenu">
					<li><a href="index.html">Home</a></li>
					<li><a href="concepts.html">Concepts</a></li>
					<li><a href="code.html">Code</a></li>
				</ul>
			</nav>
			
				</div>
			</header>
			<div id="content">

			<h1>Code</h1>
<a name="start"></a><h2 onclick="return; $(this).next().slideToggle(500);">Before we start</h2>
<div class="answer">
	<p>Busit supports multiple programming languages for connectors. 
	However, only <strong>PHP 5</strong> is open for developers at this time. 
	You can find the complete reference on <a href="http://php.net/">php.net</a>.<br />
	It is highly recommended that you'd be familiar with <a href="http://en.wikipedia.org/wiki/Object-oriented_programming">OOP</a>.</p>
	<ul>
		<li>Connectors are <strong>stateless</strong> and must have a parameterless constructor, see <a href="#lifecycle">lifecycle</a> section for more details.</li>
		<li>PHP connectors are using <a href="http://php.net/manual/en/language.namespaces.php">namespaces</a>. 
			However, it is recommended that you leave your code in the default namespace.</li>
		<li>PHP connectors are composed of at least one class <em>(and ideally only one)</em>.</li>
		<li>Connectors must be <a href="publish.html">validated by Busit</a> prior to be available on the platform.</li>
		<li>All programming languages supported share the same object model <em>(as close as possible)</em>, 
			this may lead to unusual methods or structures for certain languages but allows to have a common meaningful documentation.</li>
		<li>For most accurate class documentation, see the <a href="https://www.busit.com/busit/doc/javadoc/">javadoc</a></li>
	</ul>
</div>

<a name="basic"></a><h2 onclick="return; $(this).next().slideToggle(500);">Basic structure</h2>
<div class="answer">
	<p>There are 2 basic requirements for a PHP connector:</p>
	<ol>
		<li>There must be a <strong>define</strong> statement for <strong>__CLASSNAME__</strong> to provide the name of the class to be instanciated.</li>
		<!--li>There must be a namespace <strong>use</strong> statement to import <strong>com\busit</strong> classes.</li-->
		<li>There must be a <strong>class</strong> which's name matches the <strong>__CLASSNAME__</strong> define, and that either:
			<ul><li><strong>implements</strong> the interface <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IConnector.html">
			<em>com\busit\IConnector</em></a>, OR</li>
			<li><strong>extends</strong> the abstract class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html">
			<em>com\busit\Connector</em></a> <em>(recommended)</em></li></ul>
		</li>
	</ol>
	
	<pre><code class="php">
&lt;?php
define("__CLASSNAME__", "\\MyConnector");

class MyConnector extends com\busit\Connector
{
}

?&gt;
	</code></pre>
</div>

<a name="lifecycle"></a><h2 onclick="return; $(this).next().slideToggle(500);">Connector lifecycle</h2>
<div class="answer">
	<p>Everytime a connector is triggered, a new instance of the class is created. After processing the message, the class instance is destroyed. 
	This means that there is no persistency nor any kind of state of the class: connectors are <strong>stateless</strong>.
	If your connector absolutely requires an internal state or some sort of history, you should setup one of your own using external services or you 
	should have a <em>premium developper account</em> so that Busit provides such mechanism to you.</p>
	<p>Context:</p>
	<ol>
		<li>You create a connector and publish it on the Busit store.</li>
		<li>A user adds your connector to one of his own flows.</li>
		<li>The user configures his copy of your connector, this is stored in the Busit database.</li>
		<li>The user sends a message to his flow...</li>
	</ol>
	<p>Server side:</p>
	<ol>
		<li>The Busit broker detects that the message is targetting your connector.</li>
		<li>Your code is retreived from the connector store and the class specified by the <strong>__CLASSNAME__</strong> define is instanciated using a parameterless constructor.</li>
		<li>The user configuration, inputs and outputs are retreived and passed to the <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IConnector.html#init(java.util.Map,%20java.util.Map,%20java.util.Map)">
			<em>com\busit\IConnector.init()</em></a> method.
			<ul><li>If you extended the class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html"><em>com\busit\Connector</em></a>, then all is handled for you.</li></ul>
		</li>
		<li>The user message is passed to the <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IConnector.html#setInput(com.busit.IMessage,%20java.lang.String)"><em>com\busit\IConnector.setInput()</em></a> method.
			<ul>
				<li>If you extended the class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html"><em>com\busit\Connector</em></a>, then the 
					<a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html#push(com.busit.IMessage,%20com.busit.Connector.Interface)"><em>push()</em></a> method is called.</li>
				<li>If you implemented the <strong>Consumer</strong> pattern, then the <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Consumer.html#consume(com.busit.IMessage,%20com.busit.Connector.Interface)"><em>consume()</em></a> method is called.</li>
			</ul>
		</li>
		<li>The Busit broker checks if there are any other connectors in the flow ; if there are any, the 
			<a href="https://www.busit.com/busit/doc/javadoc/com/busit/IConnector.html#getOutput(java.lang.String)"><em>com\busit\IConnector.getOutput()</em></a> method is called.
			<ul>
				<li>If you extended the class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html"><em>com\busit\Connector</em></a>, then the 
					<a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html#pull(com.busit.Connector.Interface)"><em>pull()</em></a> method is called.</li>
				<li>If you implemented the <strong>Producer</strong> pattern, then the <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Producer.html#produce(com.busit.IMessage,%20com.busit.Connector.Interface)"><em>produce()</em></a> method is called.</li>
				<li>If you implemented the <strong>Transformer</strong> pattern, then the <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Transformer.html#transform(com.busit.IMessage,%20com.busit.Connector.Interface,%20com.busit.Connector.Interface)"><em>transform()</em></a> method is called.</li>
			</ul>
		</li>
		<li>Your connector's class instance is destroyed</li>
	</ol>
</div>

<a name="producer"></a><h2 onclick="return; $(this).next().slideToggle(500);">Producer pattern</h2>
<div class="answer">
	<p>If your connector brings data from external devices or services, it is producing data for Busit.<br />
	External devices or services can <strong>push</strong> data directly on your connector, or your connector can <strong>pull</strong>
	from those at regular intervals (see <a href="#cron">automatic interfaces</a>)</p>
	<p>There are 2 conditions to fulfill if you want to be a producer:</p>
	<ol>
		<li>Your class must <strong>extend</strong> the abstract class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html"><em>com\busit\Connector</em></a>.</li>
		<li>Your class must <strong>implement</strong> the interface <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Producer.html"><em>com\busit\Producer</em></a>.</li>
	</ol>
	<p>The producer pattern provides a single <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Producer.html#produce(com.busit.IMessage,%20com.busit.Connector.Interface)"><em>consume()</em></a> method with the following signature:</p>
	<pre><code class="php">public function produce($message, $out)</code></pre>
	<ul>
		<li>The <strong>$message</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IMessage.html"><em>com\busit\IMessage</em></a> and represents an 
			empty message container that is already initialized with the user credentials. <a href="#messages">More about Messages</a>.</li>
		<li>The <strong>$out</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Interface.html"><em>com\busit\Interface</em></a> and represents the output
			interface that should produce data. <a href="#interfaces">More about Interfaces</a>.</li>
		<li>The method must return the same <strong>$message</strong> that was provided <em>(filled with data, of course)</em> or
			<em>null</em> if there is no message content to be produced.</li>
	</ul>
	<pre><code class="php">
&lt;?php
define("__CLASSNAME__", "\\WeatherStation");

class WeatherStation extends com\busit\Connector implements com\busit\Producer
{
	public function produce($message, $out)
	{
		if( !$this-&gt;hasData() )
			return null;
			
		if( $out-&gt;key == 'pressure' )
			$message-&gt;setContentUTF8("Pressure is " . $this-&gt;getPressure());
			
		if( $out-&gt;key == 'temperature' )
			$message-&gt;setContentUTF8("Temperature is " . $this-&gt;getTemperature());
			
		return $message;
	}
	
	private function hasData() { ... }
	private function getPressure() { ... }
	private function getTemperature() { ... }
}

?&gt;
	</code></pre>
</div>

<a name="consumer"></a><h2 onclick="return; $(this).next().slideToggle(500);">Consumer pattern</h2>
<div class="answer">
	<p>If your connector sends data to external devices or services, it is consuming data from Busit.</p>
	<p>There are 2 conditions to fulfill if you want to be a consumer:</p>
	<ol>
		<li>Your class must <strong>extend</strong> the abstract class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html"><em>com\busit\Connector</em></a>.</li>
		<li>Your class must <strong>implement</strong> the interface <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Consumer.html"><em>com\busit\Consumer</em></a>.</li>
	</ol>
	<p>The consumer pattern provides a single <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Consumer.html#consume(com.busit.IMessage,%20com.busit.Connector.Interface)"><em>consume()</em></a> method with the following signature:</p>
	<pre><code class="php">public function consume($message, $in)</code></pre>
	<ul>
		<li>The <strong>$message</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IMessage.html"><em>com\busit\IMessage</em></a> and contains the actual data. 
			<a href="#messages">More about Messages</a>.</li>
		<li>The <strong>$in</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Interface.html"><em>com\busit\Interface</em></a> and represents the input
			interface to which data should be sent. <a href="#interfaces">More about Interfaces</a>.</li>
		<li>The method does not return anything.</li>
	</ul>
	<pre><code class="php">
&lt;?php
define("__CLASSNAME__", "\\Light");

class Light extends com\busit\Connector implements com\busit\Consumer
{
	public function consume($message, $in)
	{
		if( $in-&gt;key == 'state' )
		{
			if( $message-&gt;getContentUTF8() == 'ON' )
				$this-&gt;turnOn();
			else
				$this-&gt;turnOff();
		}
		
		if( $in-&gt;key == 'color' )
			$this-&gt;changeColor($message-&gt;getContentUTF8());
	}
	
	private function turnOn() { ... }
	private function turnOff() { ... }
	private function changeColor($color) { ... }
}

?&gt;
	</code></pre>
</div>

<a name="transformer"></a><h2 onclick="return; $(this).next().slideToggle(500);">Transformer pattern</h2>
<div class="answer">
	<p>If your connector aims at modifying or enhancing data eventually using external services, it is transforming data for Busit.</p>
	<p>There are 2 conditions to fulfill if you want to be a transformer:</p>
	<ol>
		<li>Your class must <strong>extend</strong> the abstract class <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html"><em>com\busit\Connector</em></a>.</li>
		<li>Your class must <strong>implement</strong> the interface <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Transformer.html"><em>com\busit\Transformer</em></a>.</li>
	</ol>
	<p>The transformer pattern provides a single <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Transformer.html#transform(com.busit.IMessage,%20com.busit.Connector.Interface,%20com.busit.Connector.Interface)"><em>transform()</em></a> method with the following signature:</p>
	<pre><code class="php">public function transform($message, $in, $out)</code></pre>
	<ul>
		<li>The <strong>$message</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IMessage.html"><em>com\busit\IMessage</em></a> and contains the actual data. 
			<a href="#messages">More about Messages</a>.</li>
		<li>The <strong>$in</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Interface.html"><em>com\busit\Interface</em></a> and gives you a hint on what data is comming in.
			 <a href="#interfaces">More about Interfaces</a>.</li>
		<li>The <strong>$out</strong> parameter is of type <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Interface.html"><em>com\busit\Interface</em></a> and tells you what the user wants to come out.
			<a href="#interfaces">More about Interfaces</a>.</li>
		<li>The method must return the same <strong>$message</strong> that was provided <em>(with its data transformed, of course)</em> or
			<em>null</em> if you want to stop the flow and prevent further processing.</li>
	</ul>
	<pre><code class="php">
&lt;?php
define("__CLASSNAME__", "\\Translator");

class Translator extends com\busit\Connector implements com\busit\Transformer
{
	public function transform($message, $in, $out)
	{
		if( $in-&gt;key == $out-&gt;key )
		{
			// no need to translate :)
			return $message;
		}
		
		if( $in-&gt;key == 'french' && $out-&gt;key == 'english' )
		{
			$text = $this-&gt;FRtoEN($message-&gt;getContentUTF8());
			$message-&gt;setContentUTF8($text);
			return $message;
		}
		
		if( $in-&gt;key == 'english' && $out-&gt;key == 'french' )
		{
			$text = $this-&gt;ENtoFR($message-&gt;getContentUTF8());
			$message-&gt;setContentUTF8($text);
			return $message;
		}
		
		// we do not support another translation so break the flow
		return null;
	}
	
	private function FRtoEN($text) { ... }
	private function ENtoFR($text) { ... }
}

?&gt;
	</code></pre>
</div>

<a name="messages"></a><h2 onclick="return; $(this).next().slideToggle(500);">About messages</h2>
<div class="answer">
	<em>... in progress ... </em>
</div>

<a name="interfaces"></a><h2 onclick="return; $(this).next().slideToggle(500);">About interfaces (inputs and outputs)</h2>
<div class="answer">
	<p>Interfaces <em>(do not confuse with OOP class interface)</em> are either inputs or outputs from your connector.
		When publishing your connector, you should mention the different inputs and outputs that your connector accepts and
		give each of them an internal name (the interface <strong>key</strong>) that will never change. 
		Then, the user can give it a friendly <strong>name</strong>.
		Eventually, for custom interfaces, the user can also specify a <strong>value</strong> for it.<p>
	<p>Example: The mail sender connector has only one input interface with internal key <em>email</em>.<br />
		When the user adds it to his flow, he can add several of those, and thus give them a name and a value:</p>
	<ul>
		<li><strong>Key</strong>: <em>email</em> (this cannot change, the user does not see it, this is only for you, the developper)</li>
		<li><strong>Name</strong>: <em>Bob's mail</em> (this is the friendly name set by the user)</li>
		<li><strong>Value</strong>: <em>bob@example.com</em> (this is the value set by the user)</li>
	</ul>
	<p>So now, in your code, if you implemented <a href="https://www.busit.com/busit/doc/javadoc/com/busit/IConnector.html">
		<em>com\busit\IConnector</em></a> (not recommended), you receive the interface <strong>name</strong> for every call to <em>cron()</em>,
		<em>getInput()</em> or <em>setOutput()</em> and it's your logic that determines what to do.
	</p>
	<pre><code class="php">
&lt;?php
define("__CLASSNAME__", "\\NotRecommended");

class NotRecommended implements com\busit\IConnector
{
	private $inputs = null;
	
	public function init($config, $inputs, $outputs) { $this-&gt;inputs = $inputs }
	public function cron($message, $interfaceId) { ... }
	public function setInput($message, $interfaceId)
	{
		if( !isset($this-&gt;inputs[$interfaceId]) )
			throw new \Exception("Unknown output interface name");
		
		$key = $this-&gt;inputs[$interfaceId]['key']; // email
		$name = $interfaceId; // Bob's mail
		$value = $this-&gt;inputs[$interfaceId]['value']; // bob@example.com
		...
	}
	public function getOutput($interfaceId) { ... }
}

?&gt;
	</code></pre>
	<p>
		On the other hand, if you extended <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.html">
		<em>com\busit\Connector</em></a> (recommended), then you receive a populated <a href="https://www.busit.com/busit/doc/javadoc/com/busit/Connector.Interface.html">
		<em>com\busit\Interface</em></a> object with the 3 properties <em>key</em>, <em>name</em> and <em>value</em>.
	</p>
	<pre><code class="php">
&lt;?php
define("__CLASSNAME__", "\\Recommended");

class Recommended extends com\busit\Connector implements com\busit\Consumer
{
	public function consume($message, $in)
	{
		$key = $in-&gt;key; // email
		$name = $in-&gt;name; // Bob's mail
		$value = $in-&gt;value; // bob@example.com
		...
	}
}

?&gt;
	</code></pre>
	<p>This means that now you know which input or output the message was targetting and you can behave accordingly.</p>
</div>

<a name="cron"></a><h2 onclick="return; $(this).next().slideToggle(500);">About automatic interfaces (cron)</h2>
<div class="answer">
	<em>... in progress ... </em>
</div>

<a name="configs"></a><h2 onclick="return; $(this).next().slideToggle(500);">About configurations</h2>
<div class="answer">
	<em>... in progress ... </em>
</div>

<script>hljs.initHighlightingOnLoad();</script>
			</div>
		</div>
		<footer>
			<div class="social">
				<a class="link" href="https://twitter.com/Bus_IT">
					<img src="https://images.busit.com/social//twitter.png" alt="Twitter" />
				</a>
				<a class="link" href="https://www.facebook.com/busit.net">
					<img src="https://images.busit.com/social//facebook.png" alt="Facebook" />
				</a>
				<a class="link" href="https://plus.google.com/+BusitFr" rel="publisher">
					<img src="https://images.busit.com/social//google.png" alt="Google+" />
				</a>
				<a class="link" href="https://www.linkedin.com/company/5121205">
					<img src="https://images.busit.com/social//linkedin.png" alt="LinkedIn" />
				</a>
				<a class="link" href="http://www.youtube.com/channel/UCvB9PQcyRzdf8n4AewdE_oA">
					<img src="https://images.busit.com/social//youtube.png" alt="YouTube" />
				</a>
			</div>
			<div class="copyright">&copy; <a href='https://www.busit.com'>Busit</a> | <a style='font-weight: bold;' href='http://www.sys.as'>SYS Network</a></div>
		</footer>
	</body>
</html>
